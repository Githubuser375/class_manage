<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hrh.class_manage_system.server.mapper.EmployeeCourseScheduleMapper">

    <select id="selectScheduleIdsByEmployee" resultType="java.lang.Integer">
        SELECT schedule_id
        FROM employee_course_schedule
        WHERE employee_id = #{employeeId}
    </select>

    <insert id="insert">
        INSERT INTO employee_course_schedule(employee_id, schedule_id)
        VALUES (#{employeeId}, #{scheduleId})
    </insert>

    <select id="countByScheduleId" resultType="int">
        SELECT COUNT(*)
        FROM employee_course_schedule
        WHERE schedule_id = #{scheduleId}
    </select>

<update id="assignEmployees">
    DELETE FROM employee_course_schedule
    WHERE schedule_id = #{scheduleId};

    <!-- 将list改为实际的参数名 -->
    <if test="employeeIds != null and employeeIds.size() > 0">
        INSERT INTO employee_course_schedule (schedule_id, employee_id)
        VALUES
        <foreach collection="employeeIds" item="employeeId" separator=",">
            (#{scheduleId}, #{employeeId})
        </foreach>;
    </if>

    UPDATE course_schedules cs
    JOIN courses c ON cs.course_id = c.id
    JOIN course_categories cc ON c.category_id = cc.id
    LEFT JOIN (
        SELECT schedule_id, COUNT(*) emp_count
        FROM employee_course_schedule
        WHERE schedule_id = #{scheduleId}
        GROUP BY schedule_id
    ) t ON cs.id = t.schedule_id
    SET cs.actual_fee = IFNULL(t.emp_count, 0) * cc.base_fee
    WHERE cs.id = #{scheduleId};
</update>
</mapper>